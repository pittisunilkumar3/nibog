<!DOCTYPE html>
<html>
<head>
    <title>DOB Issue Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .highlight { background: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DOB Issue Fix Test</h1>
        <p><strong>Issue:</strong> All child date of birth entries are showing "2015-01-01" instead of the actual selected date.</p>
        <p><strong>Root Cause:</strong> Payment callback is falling back to hardcoded data when pending booking data retrieval fails.</p>

        <div class="section">
            <h3>1. Test Pending Booking Creation</h3>
            <label>Child DOB:</label>
            <input type="date" id="testDob" value="2020-05-15">
            <button onclick="testPendingBooking()">Test Pending Booking</button>
            <div id="pendingResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. Test Pending Booking Retrieval</h3>
            <label>Transaction ID:</label>
            <input type="text" id="transactionId" placeholder="NIBOG_114_1755172698789">
            <button onclick="testPendingRetrieval()">Test Retrieval</button>
            <div id="retrievalResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. Test Complete Flow</h3>
            <button onclick="testCompleteFlow()">Test Complete DOB Flow</button>
            <div id="completeResult" class="result"></div>
        </div>

        <div class="section">
            <h3>4. Fix Instructions</h3>
            <div class="result warning">
<strong>IMMEDIATE FIX APPLIED:</strong>
1. ✅ Changed hardcoded "2015-01-01" fallback to current date
2. ✅ Added extensive logging to track DOB flow
3. ✅ Added validation to detect when fallback data is used

<strong>TO COMPLETELY FIX THE ISSUE:</strong>
1. Ensure pending booking data is properly saved before payment
2. Verify transaction ID matching between save and retrieval
3. Check network connectivity during payment callback
4. Monitor logs during actual payment flow

<strong>MONITORING:</strong>
- Check browser console during registration
- Check server logs during payment callback
- Look for "⚠️ WARNING: Using fallback booking data" messages
            </div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.className = `result ${className}`;
            element.textContent = `[${timestamp}] ${message}`;
        }

        async function testPendingBooking() {
            const dob = document.getElementById('testDob').value;
            log('pendingResult', 'Testing pending booking creation...', 'info');

            const testData = {
                userId: 114,
                parentName: "Test Parent",
                email: "test@example.com",
                phone: "1234567890",
                childName: "Test Child",
                childDob: dob,
                schoolName: "Test School",
                gender: "Male",
                eventId: 109,
                gameId: [9],
                gamePrice: [1],
                totalAmount: 1,
                paymentMethod: "PhonePe",
                termsAccepted: true
            };

            try {
                const response = await fetch('/api/pending-bookings/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('pendingResult', 
                        `✅ Pending booking created successfully!\n` +
                        `Transaction ID: ${result.transactionId}\n` +
                        `DOB in request: ${dob}\n` +
                        `Full response: ${JSON.stringify(result, null, 2)}`, 
                        'success'
                    );
                    
                    // Store transaction ID for retrieval test
                    document.getElementById('transactionId').value = result.transactionId;
                } else {
                    log('pendingResult', 
                        `❌ Failed to create pending booking\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(result, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                log('pendingResult', `❌ Error: ${error.message}`, 'error');
            }
        }

        async function testPendingRetrieval() {
            const transactionId = document.getElementById('transactionId').value;
            if (!transactionId) {
                log('retrievalResult', '❌ Please enter a transaction ID', 'error');
                return;
            }

            log('retrievalResult', 'Testing pending booking retrieval...', 'info');

            try {
                const response = await fetch('/api/pending-bookings/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transaction_id: transactionId
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    const dob = result.bookingData?.childDob;
                    const isHardcoded = dob === "2015-01-01";
                    
                    log('retrievalResult', 
                        `✅ Pending booking retrieved successfully!\n` +
                        `DOB: ${dob} ${isHardcoded ? '⚠️ (HARDCODED!)' : '✅ (Actual data)'}\n` +
                        `Child Name: ${result.bookingData?.childName}\n` +
                        `Parent Name: ${result.bookingData?.parentName}\n` +
                        `Full response: ${JSON.stringify(result, null, 2)}`, 
                        isHardcoded ? 'warning' : 'success'
                    );
                } else {
                    log('retrievalResult', 
                        `❌ Failed to retrieve pending booking\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(result, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                log('retrievalResult', `❌ Error: ${error.message}`, 'error');
            }
        }

        async function testCompleteFlow() {
            log('completeResult', 'Testing complete DOB flow...', 'info');
            
            const dob = document.getElementById('testDob').value;
            let output = `Testing with DOB: ${dob}\n\n`;
            
            // Step 1: Create pending booking
            output += "STEP 1: Creating pending booking...\n";
            
            const testData = {
                userId: 114,
                parentName: "Flow Test Parent",
                email: "flowtest@example.com",
                phone: "9876543210",
                childName: "Flow Test Child",
                childDob: dob,
                schoolName: "Flow Test School",
                gender: "Female",
                eventId: 109,
                gameId: [9],
                gamePrice: [1],
                totalAmount: 1,
                paymentMethod: "PhonePe",
                termsAccepted: true
            };

            try {
                const createResponse = await fetch('/api/pending-bookings/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const createResult = await createResponse.json();
                
                if (createResponse.ok) {
                    output += `✅ Pending booking created with transaction ID: ${createResult.transactionId}\n\n`;
                    
                    // Step 2: Retrieve pending booking
                    output += "STEP 2: Retrieving pending booking...\n";
                    
                    const retrieveResponse = await fetch('/api/pending-bookings/get', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            transaction_id: createResult.transactionId
                        })
                    });

                    const retrieveResult = await retrieveResponse.json();
                    
                    if (retrieveResponse.ok) {
                        const retrievedDob = retrieveResult.bookingData?.childDob;
                        const dobMatches = retrievedDob === dob;
                        
                        output += `✅ Pending booking retrieved\n`;
                        output += `Original DOB: ${dob}\n`;
                        output += `Retrieved DOB: ${retrievedDob}\n`;
                        output += `DOB Match: ${dobMatches ? '✅ YES' : '❌ NO'}\n\n`;
                        
                        if (dobMatches) {
                            output += "🎉 SUCCESS: DOB flow is working correctly!\n";
                            output += "The issue might be in the payment callback logic or transaction ID matching.\n";
                            log('completeResult', output, 'success');
                        } else {
                            output += "❌ ISSUE FOUND: DOB is not being preserved correctly!\n";
                            output += "Check the pending booking storage logic.\n";
                            log('completeResult', output, 'error');
                        }
                    } else {
                        output += `❌ Failed to retrieve pending booking: ${retrieveResponse.status}\n`;
                        log('completeResult', output, 'error');
                    }
                } else {
                    output += `❌ Failed to create pending booking: ${createResponse.status}\n`;
                    log('completeResult', output, 'error');
                }
            } catch (error) {
                output += `❌ Error in complete flow test: ${error.message}\n`;
                log('completeResult', output, 'error');
            }
        }
    </script>
</body>
</html>
