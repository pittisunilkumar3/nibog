<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOB Booking Flow Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #fafafa;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, select { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            width: 200px;
        }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            max-height: 300px; 
            overflow-y: auto;
        }
        .payload-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DOB Booking Flow Test</h1>
        <p>This tool tests the complete DOB flow from form input to API payload and tests the booking API.</p>

        <div class="test-section">
            <h3>1. Test DOB Formatting Functions</h3>
            <button onclick="testDOBFormatting()">Test DOB Formatting</button>
            <div id="dobFormattingResults" class="log"></div>
        </div>

        <div class="test-section">
            <h3>2. Simulate Registration Form Flow</h3>
            <label>Select Child DOB:</label>
            <input type="date" id="childDob" value="2015-01-01">
            <button onclick="simulateFormFlow()">Simulate Form Flow</button>
            <div id="formFlowResults" class="log"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Your Exact Booking API Payload</h3>
            <button onclick="testYourPayload()">Test Your Payload</button>
            <div id="yourPayloadResults" class="log"></div>
            <div id="yourPayloadDisplay" class="payload-display"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Booking API with Simulated Form Data</h3>
            <button onclick="testBookingAPIWithFormData()">Test API with Form Data</button>
            <div id="apiTestResults" class="log"></div>
            <div id="apiPayloadDisplay" class="payload-display"></div>
        </div>

        <div class="test-section">
            <h3>5. Debug DOB Issue</h3>
            <button onclick="debugDOBIssue()">Debug DOB Issue</button>
            <div id="debugResults" class="log"></div>
        </div>
    </div>

    <script>
        // Simulate the formatDateForAPI function from the codebase
        function formatDateForAPI(date) {
            if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            } else if (typeof date === 'string') {
                return date.includes('T') ? date.split('T')[0] : date;
            } else {
                throw new Error('Invalid date format');
            }
        }

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function testDOBFormatting() {
            clearLog('dobFormattingResults');
            log('dobFormattingResults', '=== TESTING DOB FORMATTING FUNCTIONS ===');
            
            const testCases = [
                { name: 'Date object (2015-01-01)', input: new Date('2015-01-01') },
                { name: 'Date object (2020-05-15)', input: new Date('2020-05-15') },
                { name: 'String YYYY-MM-DD', input: '2015-01-01' },
                { name: 'ISO string', input: '2020-05-15T00:00:00.000Z' },
                { name: 'Date with time', input: new Date('2015-01-01T10:30:00.000Z') }
            ];

            testCases.forEach((testCase, index) => {
                try {
                    const result = formatDateForAPI(testCase.input);
                    const isValid = /^\d{4}-\d{2}-\d{2}$/.test(result);
                    log('dobFormattingResults', `Test ${index + 1}: ${testCase.name}`, 'info');
                    log('dobFormattingResults', `  Input: ${testCase.input}`, 'info');
                    log('dobFormattingResults', `  Output: ${result}`, 'info');
                    log('dobFormattingResults', `  Valid: ${isValid ? '✅' : '❌'}`, isValid ? 'success' : 'error');
                } catch (error) {
                    log('dobFormattingResults', `Test ${index + 1}: ${testCase.name} - ERROR: ${error.message}`, 'error');
                }
            });
        }

        function simulateFormFlow() {
            clearLog('formFlowResults');
            log('formFlowResults', '=== SIMULATING REGISTRATION FORM FLOW ===');
            
            const dobInput = document.getElementById('childDob').value;
            log('formFlowResults', `1. User input from date picker: ${dobInput}`, 'info');
            
            // Simulate how the form handles the date
            const userSelectedDate = new Date(dobInput);
            log('formFlowResults', `2. Converted to Date object: ${userSelectedDate}`, 'info');
            log('formFlowResults', `   Date type: ${typeof userSelectedDate}`, 'info');
            log('formFlowResults', `   Date toString: ${userSelectedDate.toString()}`, 'info');
            log('formFlowResults', `   Date toISOString: ${userSelectedDate.toISOString()}`, 'info');
            
            // Format for storage (as done in handleDobChange)
            const formattedDob = formatDateForAPI(userSelectedDate);
            log('formFlowResults', `3. Formatted for storage: ${formattedDob}`, 'info');
            
            // Simulate booking data creation (as done in handlePayment)
            const bookingData = {
                childDob: formattedDob
            };
            log('formFlowResults', `4. Booking data childDob: ${bookingData.childDob}`, 'info');
            
            // Simulate formatBookingDataForAPI function
            const apiFormattedDob = formatDateForAPI(bookingData.childDob);
            log('formFlowResults', `5. API formatted DOB: ${apiFormattedDob}`, 'info');
            
            // Final API payload
            const apiPayload = {
                child: {
                    date_of_birth: apiFormattedDob
                }
            };
            log('formFlowResults', `6. Final API payload child.date_of_birth: ${apiPayload.child.date_of_birth}`, 'info');
            
            // Validation
            const isValid = /^\d{4}-\d{2}-\d{2}$/.test(apiPayload.child.date_of_birth);
            log('formFlowResults', `7. Format validation: ${isValid ? '✅ Valid YYYY-MM-DD' : '❌ Invalid format'}`, isValid ? 'success' : 'error');
        }

        function testYourPayload() {
            clearLog('yourPayloadResults');
            clearLog('yourPayloadDisplay');
            
            const payload = {
                "user_id": 114,
                "parent": {
                    "parent_name": "Pitti Sunil Kumar",
                    "email": "pittisunilkumar3@gmail.com",
                    "additional_phone": "6303727148"
                },
                "child": {
                    "full_name": "Pitti Sunil Kumar",
                    "date_of_birth": "2015-01-01",
                    "school_name": "hgfds",
                    "gender": "Male"
                },
                "booking": {
                    "event_id": 109,
                    "booking_date": "2025-08-14",
                    "total_amount": 1,
                    "payment_method": "PhonePe",
                    "payment_status": "Paid",
                    "terms_accepted": true,
                    "transaction_id": "OMO2508141555013643309314",
                    "merchant_transaction_id": "NIBOG_114_1755167101252",
                    "booking_ref": "PPT250814314",
                    "status": "Confirmed"
                },
                "booking_games": [
                    {
                        "slot_id": 339,
                        "game_id": 9,
                        "game_price": 1
                    }
                ]
            };

            document.getElementById('yourPayloadDisplay').textContent = JSON.stringify(payload, null, 2);
            
            log('yourPayloadResults', '=== TESTING YOUR EXACT PAYLOAD ===');
            log('yourPayloadResults', `DOB in payload: ${payload.child.date_of_birth}`, 'info');
            
            const isValidDOB = /^\d{4}-\d{2}-\d{2}$/.test(payload.child.date_of_birth);
            log('yourPayloadResults', `DOB format validation: ${isValidDOB ? '✅ Valid YYYY-MM-DD' : '❌ Invalid format'}`, isValidDOB ? 'success' : 'error');
            
            // Test the API call
            testBookingAPI(payload, 'yourPayloadResults');
        }

        async function testBookingAPI(payload, logElementId) {
            log(logElementId, 'Making API call to booking endpoint...', 'info');
            
            try {
                const response = await fetch('https://ai.alviongs.com/webhook/v1/nibog/bookingsevents/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                log(logElementId, `Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(logElementId, `Response status text: ${response.statusText}`, 'info');
                
                const responseText = await response.text();
                log(logElementId, `Raw response: ${responseText}`, 'info');
                
                try {
                    const responseData = JSON.parse(responseText);
                    log(logElementId, `Parsed response: ${JSON.stringify(responseData, null, 2)}`, 'success');
                } catch (parseError) {
                    log(logElementId, `Could not parse response as JSON: ${parseError.message}`, 'warning');
                }
                
            } catch (error) {
                log(logElementId, `API call failed: ${error.message}`, 'error');
            }
        }

        function testBookingAPIWithFormData() {
            clearLog('apiTestResults');
            clearLog('apiPayloadDisplay');
            
            log('apiTestResults', '=== TESTING BOOKING API WITH FORM DATA ===');
            
            const dobInput = document.getElementById('childDob').value;
            const userSelectedDate = new Date(dobInput);
            const formattedDob = formatDateForAPI(userSelectedDate);
            
            const payload = {
                "user_id": 114,
                "parent": {
                    "parent_name": "Test Parent",
                    "email": "test@example.com",
                    "additional_phone": "1234567890"
                },
                "child": {
                    "full_name": "Test Child",
                    "date_of_birth": formattedDob,
                    "school_name": "Test School",
                    "gender": "Male"
                },
                "booking": {
                    "event_id": 109,
                    "booking_date": "2025-08-14",
                    "total_amount": 1,
                    "payment_method": "PhonePe",
                    "payment_status": "Paid",
                    "terms_accepted": true,
                    "transaction_id": "TEST_" + Date.now(),
                    "merchant_transaction_id": "TEST_MERCHANT_" + Date.now(),
                    "booking_ref": "TEST_" + Date.now(),
                    "status": "Confirmed"
                },
                "booking_games": [
                    {
                        "slot_id": 339,
                        "game_id": 9,
                        "game_price": 1
                    }
                ]
            };

            document.getElementById('apiPayloadDisplay').textContent = JSON.stringify(payload, null, 2);
            
            log('apiTestResults', `Generated DOB from form: ${formattedDob}`, 'info');
            
            const isValidDOB = /^\d{4}-\d{2}-\d{2}$/.test(formattedDob);
            log('apiTestResults', `DOB format validation: ${isValidDOB ? '✅ Valid YYYY-MM-DD' : '❌ Invalid format'}`, isValidDOB ? 'success' : 'error');
            
            // Test the API call
            testBookingAPI(payload, 'apiTestResults');
        }

        function debugDOBIssue() {
            clearLog('debugResults');
            log('debugResults', '=== DEBUGGING DOB ISSUE ===');
            
            log('debugResults', 'Checking your payload DOB:', 'info');
            const yourDOB = "2015-01-01";
            log('debugResults', `Your DOB: ${yourDOB}`, 'info');
            log('debugResults', `DOB type: ${typeof yourDOB}`, 'info');
            log('debugResults', `DOB format: ${/^\d{4}-\d{2}-\d{2}$/.test(yourDOB) ? '✅ Valid YYYY-MM-DD' : '❌ Invalid format'}`, 'info');
            
            log('debugResults', '\nChecking if the issue is in the form:', 'info');
            const dobInput = document.getElementById('childDob').value;
            log('debugResults', `Form input value: ${dobInput}`, 'info');
            
            if (dobInput) {
                const dateObj = new Date(dobInput);
                const formatted = formatDateForAPI(dateObj);
                log('debugResults', `Converted to Date: ${dateObj}`, 'info');
                log('debugResults', `Formatted: ${formatted}`, 'info');
                log('debugResults', `Matches your DOB: ${formatted === yourDOB ? '✅ Yes' : '❌ No'}`, formatted === yourDOB ? 'success' : 'error');
            }
            
            log('debugResults', '\nPossible issues to check:', 'warning');
            log('debugResults', '1. Check browser console for errors during form submission', 'warning');
            log('debugResults', '2. Verify the DOB state is properly set in React component', 'warning');
            log('debugResults', '3. Check if there are any validation errors preventing form submission', 'warning');
            log('debugResults', '4. Verify the formatDateForAPI function is working correctly', 'warning');
            log('debugResults', '5. Check if the DOB is being overwritten somewhere in the flow', 'warning');
        }
    </script>
</body>
</html>
