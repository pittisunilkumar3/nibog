/**
 * Test ticket email generation with QR codes
 */

async function testTicketEmailGeneration() {
  console.log('ğŸ§ª Testing ticket email generation with QR codes...');
  
  const testTicketData = {
    bookingId: 12345,
    bookingRef: 'PPT123456789',
    parentEmail: 'test@example.com',
    parentName: 'Test Parent',
    childName: 'Test Child',
    eventTitle: 'Birthday Party Celebration',
    eventDate: '2024-01-15',
    eventVenue: 'NIBOG Party Hall, Bangalore',
    qrCodeData: JSON.stringify({
      ref: 'PPT123456789',
      id: 12345,
      name: 'Test Child',
      game: 'Birthday Party Celebration',
      slot: 'Morning Session'
    }),
    ticketDetails: [
      {
        booking_id: 12345,
        booking_game_id: 1,
        game_id: 101,
        game_name: 'Musical Chairs',
        custom_title: 'Musical Chairs Fun',
        custom_description: 'A fun musical chairs game for kids',
        custom_price: 1500,
        slot_price: 1500,
        start_time: '10:00 AM',
        end_time: '11:00 AM',
        event_title: 'Birthday Party Celebration',
        event_date: '2024-01-15',
        parent_name: 'Test Parent',
        parent_email: 'test@example.com',
        child_name: 'Test Child',
        event_game_slot_id: 201
      }
    ]
  };

  try {
    // First get email settings
    console.log('ğŸ“§ Getting email settings...');
    const settingsResponse = await fetch('http://localhost:3111/api/emailsetting/get');
    const settingsResult = await settingsResponse.json();

    if (!settingsResult.success) {
      throw new Error('Failed to get email settings');
    }

    const emailSettings = settingsResult.data[0];
    console.log('âœ… Email settings retrieved');

    console.log('ğŸ“§ Testing ticket email API endpoint...');
    console.log('ğŸ“‹ Ticket data:', JSON.stringify(testTicketData, null, 2));

    const response = await fetch('http://localhost:3111/api/send-ticket-email-with-attachment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        to: testTicketData.parentEmail,
        subject: `ğŸ« Your Tickets - ${testTicketData.eventTitle} | NIBOG`,
        html: '<h1>Test HTML Content</h1><p>This is a test ticket email with QR code.</p><img src="cid:qrcode" alt="QR Code" style="width: 200px; height: 200px;">',
        settings: emailSettings,
        bookingRef: testTicketData.bookingRef,
        qrCodeBuffer: [], // Will be generated by the service
        ticketDetails: testTicketData.ticketDetails
      }),
    });

    const result = await response.json();
    
    console.log('ğŸ“¡ API Response Status:', response.status);
    console.log('ğŸ“¡ API Response:', JSON.stringify(result, null, 2));

    if (result.success) {
      console.log('âœ… Ticket email with PDF generated successfully!');
      console.log(`ğŸ“§ Message ID: ${result.messageId}`);
      console.log(`ğŸ“ Attachments: ${result.attachments}`);
    } else {
      console.log('âŒ Failed to generate ticket email with PDF');
      console.log('âŒ Error:', result.error);
    }

  } catch (error) {
    console.error('ğŸš¨ Test failed:', error.message);
  }
}

// Run the test
testTicketEmailGeneration();
